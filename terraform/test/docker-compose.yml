# Docker Compose file for Terraform testing

services:
  # Main test service
  terraform-tests:
    build:
      context: .
      dockerfile: Dockerfile
    image: terraform-tests:latest
    volumes:
      - ../:/workspace/terraform-src:ro
      - ~/.azure:/root/.azure:ro
      - ~/.kube:/root/.kube:ro
      - ./test-results:/workspace/test-results
    environment:
      - TF_IN_AUTOMATION=true
      - ARM_SKIP_PROVIDER_REGISTRATION=true
      - ARM_CLIENT_ID=${ARM_CLIENT_ID}
      - ARM_CLIENT_SECRET=${ARM_CLIENT_SECRET}
      - ARM_SUBSCRIPTION_ID=${ARM_SUBSCRIPTION_ID}
      - ARM_TENANT_ID=${ARM_TENANT_ID}
    working_dir: /workspace
    command: ["Quick"]

  # Unit tests specifically
  terraform-unit:
    build:
      context: .
      dockerfile: Dockerfile
    image: terraform-tests:latest
    volumes:
      - ../:/workspace/terraform-src:ro
      - ~/.azure:/root/.azure:ro
      - ./test-results:/workspace/test-results:rw
      - ./.terraform-cache:/tmp/terraform-cache
      - ./unit:/workspace/unit:ro
      - ./run-unit-tests.sh:/run-unit-tests.sh:ro
    environment:
      - TF_IN_AUTOMATION=true
      - ARM_SKIP_PROVIDER_REGISTRATION=true
      - CGO_ENABLED=0
      - GOOS=linux
      - TF_PLUGIN_CACHE_DIR=/tmp/terraform-cache
    working_dir: /workspace
    command: ["Unit"]

  # Interactive shell
  terraform-shell:
    build:
      context: .
      dockerfile: Dockerfile
    image: terraform-tests:latest
    volumes:
      - ../:/workspace/terraform-src:ro
      - ~/.azure:/root/.azure:ro
      - ~/.kube:/root/.kube:ro
    environment:
      - TF_IN_AUTOMATION=true
      - ARM_SKIP_PROVIDER_REGISTRATION=true
    working_dir: /workspace
    command: ["bash"]
    stdin_open: true
    tty: true